# !!!!!!!!!!!!!!! This is going to take ages and use huge amounts of memory
# Import libraries
library(bigmemory)
library(biganalytics)
library(bigtabulate)

# Read in data
# Input data are r2 reports generated by plink for each population separately.
# Create such plink inputs in bed format and run the following script:

##!/bin/bash
#
#for i in *.bed; do 
#plink --bfile ${i%.bed} --aec --r2 inter-chr gz --ld-window-r2 0 --threads 4 --out ${i%.bed}
#gzip -d ${i%.bed}.ld.gz
#awk '{print $7}' ${i%.bed}.ld > ${i%.bed}_r2.txt
#rm ${i%.bed}.ld
#done

a99.matrix<-read.big.matrix("Nacella_A99OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="a99.bin",descriptorfile="a20.desc",extraCols=NULL)
a20.matrix<-read.big.matrix("Nacella_AN20OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="a20.bin",descriptorfile="a20.desc",extraCols=NULL)
d.matrix<-read.big.matrix("Nacella_DROnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="dr20.bin",descriptorfile="dr20.desc",extraCols=NULL)
eb99.matrix<-read.big.matrix("Nacella_EB99OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="eb99.bin",descriptorfile="eb99.desc",extraCols=NULL)
eb20.matrix<-read.big.matrix("Nacella_EB20OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="eb20.bin",descriptorfile="eb20.desc",extraCols=NULL)
g.matrix<-read.big.matrix("Nacella_GOnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="g20.bin",descriptorfile="g20.desc",extraCols=NULL)
l99.matrix<-read.big.matrix("Nacella_L99OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="l99.bin",descriptorfile="l99.desc",extraCols=NULL)
l20.matrix<-read.big.matrix("Nacella_L20OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="l20.bin",descriptorfile="l20.desc",extraCols=NULL)
m3.matrix<-read.big.matrix("Nacella_M3OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="m3.bin",descriptorfile="m3.desc",extraCols=NULL)
rg99.matrix<-read.big.matrix("Nacella_RG99OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="rg99.bin",descriptorfile="rg99.desc",extraCols=NULL)
rg20.matrix<-read.big.matrix("Nacella_RG20OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="rg20.bin",descriptorfile="rg20.desc",extraCols=NULL)
rs.matrix<-read.big.matrix("Nacella_RS99OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="rs.bin",descriptorfile="rs.desc",extraCols=NULL)
t99.matrix<-read.big.matrix("Nacella_T99OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="t99.bin",descriptorfile="t99.desc",extraCols=NULL)
t20.matrix<-read.big.matrix("Nacella_T20OnlyPoli_MAF1_r2.txt",type="double",header=T,backingfile="t20.bin",descriptorfile="t20.desc",extraCols=NULL)

labs<-c("a99.matrix","a20.matrix","d.matrix","eb99.matrix","eb20.matrix","g.matrix","l99.matrix","l20.matrix","m3.matrix","rg99.matrix","rg20.matrix","rs.matrix","t99.matrix","t20.matrix")

means<-c(
mean(a99.matrix[,1]),
mean(a20.matrix[,1]),
mean(d.matrix[,1]),
mean(eb99.matrix[,1]),
mean(eb20.matrix[,1]),
mean(g.matrix[,1]),
mean(l99.matrix[,1]),
mean(l20.matrix[,1]),
mean(m3.matrix[,1]),
mean(rg99.matrix[,1]),
mean(rg20.matrix[,1]),
mean(rs.matrix[,1]),
mean(t99.matrix[,1]),
mean(t20.matrix[,1]))
write.table(means,"r2_means.txt",quote=F,col.names=F,row.names=F,sep="\t")

sds<-c(
sd(a99.matrix[,1]),
sd(a20.matrix[,1]),
sd(d.matrix[,1]),
sd(eb99.matrix[,1]),
sd(eb20.matrix[,1]),
sd(g.matrix[,1]),
sd(l99.matrix[,1]),
sd(l20.matrix[,1]),
sd(m3.matrix[,1]),
sd(rg99.matrix[,1]),
sd(rg20.matrix[,1]),
sd(rs.matrix[,1]),
sd(t99.matrix[,1]),
sd(t20.matrix[,1]))
write.table(sds,"r2_sds.txt",quote=F,col.names=F,row.names=F,sep="\t")

medians<-c(
median(a99.matrix[,1]),
median(a20.matrix[,1]),
median(d.matrix[,1]),
median(eb99.matrix[,1]),
median(eb20.matrix[,1]),
median(g.matrix[,1]),
median(l99.matrix[,1]),
median(l20.matrix[,1]),
median(m3.matrix[,1]),
median(rg99.matrix[,1]),
median(rg20.matrix[,1]),
median(rs.matrix[,1]),
median(t99.matrix[,1]),
median(t20.matrix[,1]))
write.table(medians,"r2_medians.txt",quote=F,col.names=F,row.names=F,sep="\t")

q25<-c(
quantile(a99.matrix[,1],0.25),
quantile(a20.matrix[,1],0.25),
quantile(d.matrix[,1],0.25),
quantile(eb99.matrix[,1],0.25),
quantile(eb20.matrix[,1],0.25),
quantile(g.matrix[,1],0.25),
quantile(l99.matrix[,1],0.25),
quantile(l20.matrix[,1],0.25),
quantile(m3.matrix[,1],0.25),
quantile(rg99.matrix[,1],0.25),
quantile(rg20.matrix[,1],0.25),
quantile(rs.matrix[,1],0.25),
quantile(t99.matrix[,1],0.25),
quantile(t20.matrix[,1],0.25))

q75<-c(
quantile(a99.matrix[,1],0.75),
quantile(a20.matrix[,1],0.75),
quantile(d.matrix[,1],0.75),
quantile(eb99.matrix[,1],0.75),
quantile(eb20.matrix[,1],0.75),
quantile(g.matrix[,1],0.75),
quantile(l99.matrix[,1],0.75),
quantile(l20.matrix[,1],0.75),
quantile(m3.matrix[,1],0.75),
quantile(rg99.matrix[,1],0.75),
quantile(rg20.matrix[,1],0.75),
quantile(rs.matrix[,1],0.75),
quantile(t99.matrix[,1],0.75),
quantile(t20.matrix[,1],0.75))

outp<-cbind(labs,means,sds,medians,q25,q75)
write.table(outp,"r2_stats.txt",quote=F,col.names=F,row.names=F,sep="\t")


p-vals<-c(
wilcox.test(a99.matrix[,1],a20.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],d.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],eb99.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],eb20.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],g.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],l99.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],l20.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(a99.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],d.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],eb99.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],eb20.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],g.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],l99.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],l20.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(a20.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],eb99.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],eb20.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],g.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],l99.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],l20.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(d.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],eb20.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],g.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],l99.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],l20.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(eb99.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],g.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],l99.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],l20.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(eb20.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],l99.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],l20.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(g.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(l99.matrix[,1],l20.matrix[,1])$p.value[1],
wilcox.test(l99.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(l99.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(l99.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(l99.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(l99.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(l99.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(l20.matrix[,1],m3.matrix[,1])$p.value[1],
wilcox.test(l20.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(l20.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(l20.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(l20.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(l20.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(m3.matrix[,1],rg99.matrix[,1])$p.value[1],
wilcox.test(m3.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(m3.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(m3.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(m3.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(rg99.matrix[,1],rg20.matrix[,1])$p.value[1],
wilcox.test(rg99.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(rg99.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(rg99.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(rg20.matrix[,1],rs.matrix[,1])$p.value[1],
wilcox.test(rg20.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(rg20.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(rs.matrix[,1],t99.matrix[,1])$p.value[1],
wilcox.test(rs.matrix[,1],t20.matrix[,1])$p.value[1],
wilcox.test(t99.matrix[,1],t20.matrix[,1])$p.value[1])

statics<-c(
wilcox.test(a99.matrix[,1],a20.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],d.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],eb99.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],eb20.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],g.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],l99.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],l20.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(a99.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],d.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],eb99.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],eb20.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],g.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],l99.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],l20.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(a20.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],eb99.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],eb20.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],g.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],l99.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],l20.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(d.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],eb20.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],g.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],l99.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],l20.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(eb99.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],g.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],l99.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],l20.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(eb20.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],l99.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],l20.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(g.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(l99.matrix[,1],l20.matrix[,1])$statistic,
wilcox.test(l99.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(l99.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(l99.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(l99.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(l99.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(l99.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(l20.matrix[,1],m3.matrix[,1])$statistic,
wilcox.test(l20.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(l20.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(l20.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(l20.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(l20.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(m3.matrix[,1],rg99.matrix[,1])$statistic,
wilcox.test(m3.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(m3.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(m3.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(m3.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(rg99.matrix[,1],rg20.matrix[,1])$statistic,
wilcox.test(rg99.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(rg99.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(rg99.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(rg20.matrix[,1],rs.matrix[,1])$statistic,
wilcox.test(rg20.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(rg20.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(rs.matrix[,1],t99.matrix[,1])$statistic,
wilcox.test(rs.matrix[,1],t20.matrix[,1])$statistic,
wilcox.test(t99.matrix[,1],t20.matrix[,1])$statistic)

tests<-cbind(statics,p-vals)
write.table(tests,"Wilcox_Tests.txt",quote=F,col.names=F,row.names=F,sep="\t")
